{"files":[{"id":"c3b84404-5627-49f8-a755-808102e9c131","name":"Code","type":"server_js","source":"function doGet(request) {\n  var result;\n  var requesttype \u003d request.parameters.type;\n  \n  var username \u003d request.parameters.username;\n  var email \u003d request.parameters.email;\n  var password \u003d request.parameters.password;\n  var callback \u003d request.parameters.callback;\n  \n  if(requesttype\u003d\u003d\"check\"){ //check username availability and email already used;\n    var error \u003d CheckAccountCreationPossible(username, email);\n    \n    if(error\u003d\u003d\"\")\n    {\n      result \u003d {error: \"none\"} \n    }\n    else\n    {\n      result \u003d {error: error}    \n    }\n  }\n  else if(requesttype\u003d\u003d\"create\"){ //create the actual account. performed once data are checked.\n    CreateUserAccount(email,username,password);\n  \n    var spreadsheetId \u003d GetSpeadsheet(username, password);\n  \n    if(spreadsheetId\u003d\u003d\"\")\n    {\n      result \u003d {id: \"none\"} \n    }\n    else\n    {\n      result \u003d {id: spreadsheetId}    \n    }\n  }\n  \n  Logger.log(result);\n  \n  return ContentService.createTextOutput(callback + \"(\" + JSON.stringify(result) + \")\")\n    .setMimeType(ContentService.MimeType.JAVASCRIPT);\n}\n\nfunction CheckAccountCreationPossible(username, email){\n  var accountss \u003d SpreadsheetApp.openByUrl(\u0027https://docs.google.com/spreadsheets/d/1svXwnhaPbj0RMUY2EDADqy17XM9zQ17NWsgp4MPjEmI/edit\u0027);\n  var sheet \u003d accountss.getSheets()[0];\n  var datalength \u003d parseInt(sheet.getRange(\"G2\").getValues()[0]);\n  \n  var data \u003d sheet.getRange(\"A2:E\"+(datalength+1)).getValues();\n  \n  var error \u003d \"\";\n  \n  for(var i \u003d 0 ; i \u003c datalength; i++){\n    if(data[i][1]\u003d\u003demail)\n    {\n      error \u003d \"Email already used\";\n      break;\n    }\n  }\n  \n  if(error \u003d\u003d \"\"){\n    for(var i \u003d 0 ; i \u003c datalength; i++){\n      if(data[i][0]\u003d\u003dusername)\n      {\n        error \u003d \"Username already taken\";\n        break;\n      }\n    }\n  }\n\n  Logger.log(error);\n  \n  return error;\n}\n\nfunction CreateUserAccount(email, name, password){\n   var ss \u003d SpreadsheetApp.openByUrl(\u0027https://docs.google.com/spreadsheets/d/1svXwnhaPbj0RMUY2EDADqy17XM9zQ17NWsgp4MPjEmI/edit\u0027);\n   var sheet \u003d ss.getSheets()[0];\n   var spreadsheetid \u003d CreateNewUserDataFromTemplate();\n   sheet.appendRow([name, email, password, \"standard\", spreadsheetid]);\n}\n\nfunction CreateNewUserDataFromTemplate() {\n   var file \u003d DriveApp.getFileById(\"1YJSCoWzveYQItt0laYM3Z6W1JJuPpAQxBSD5lNWE9NY\");\n   Logger.log(file.getName());\n   \n  \n   var folder \u003d DriveApp.getFolderById(\"0B0SfnkeFqf8ufjlwVGVMMGtjaHctbGtKRklVa2VJLVh4WnhxWUFjN0JwZzdza0JkbTR2Nm8\");\n   Logger.log(folder.getName());\n\n   var copyfile \u003d file.makeCopy(generateUUID(), folder);\n   var copyid \u003d copyfile.getId();\n   Logger.log(copyid);\n   return copyid;\n}\n\nfunction generateUUID() {\n    var d \u003d new Date().getTime();\n    var uuid \u003d \u0027xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\u0027.replace(/[xy]/g, function(c) {\n        var r \u003d (d + Math.random()*16)%16 | 0;\n        d \u003d Math.floor(d/16);\n        return (c\u003d\u003d\u0027x\u0027 ? r : (r\u00260x3|0x8)).toString(16);\n    });\n    return uuid;\n}\n\n//Description : Function that get spreadsheet data for the specified account\n//parameter : the account name\n// return : the url of the spreadsheet\nfunction GetSpeadsheet(username, password){\n  var accountss \u003d SpreadsheetApp.openByUrl(\u0027https://docs.google.com/spreadsheets/d/1svXwnhaPbj0RMUY2EDADqy17XM9zQ17NWsgp4MPjEmI/edit\u0027);\n  var sheet \u003d accountss.getSheets()[0];\n  var datalength \u003d parseInt(sheet.getRange(\"G2\").getValues()[0]);\n  \n  var data \u003d sheet.getRange(\"A2:E\"+(datalength+1)).getValues();\n  \n  var spreadsheet \u003d \"\";\n  \n  for(var i \u003d 0 ; i \u003c datalength; i++){\n    Logger.log(data[i][0]);\n    if(data[i][0]\u003d\u003dusername)\n    {\n      if(data[i][2]\u003d\u003dpassword)\n      {\n        spreadsheet \u003d data[i][4];\n        break;\n      }\n    }\n  }\n\n  Logger.log(spreadsheet);\n  \n  return spreadsheet;\n}"}]}